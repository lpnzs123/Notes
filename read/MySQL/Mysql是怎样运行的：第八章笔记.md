# Mysql是怎样运行的：第八章笔记

---

## 笔记正文

---

### 数据库和文件系统

---

像 InnoDB 、MyISAM 这样的存储引擎都是把表存储在文件系统（磁盘）上的。

<br />

### MySQL 数据目录

---

MySQL 服务器程序在启动时会到文件系统的某个目录下加载一些文件，之后在运行过程中产生的数据也都会存储到这个目录下的某些文件中，这个目录就称为数据目录。

<br />

#### 数据目录和安装目录的区别

---

MySQL 的安装目录即安装 MySQL 时的目录（我们可以自己指定）。MySQL 的数据目录即用来存储 MySQL 在运行过程中产生的数据。

<br />

#### MySQL 的数据目录位置

---

通过在客户端中查询系统变量 datadir ，我们可以得知 MySQL 数据目录的位置。

```mysql
SHOW VARIABLES LIKE 'datadir';
```

<br />

#### MySQL 数据目录的结构

---

##### 数据库在文件系统中的表示

---

每个数据库都对应数据目录下的一个子目录，或者说对应一个文件夹。每当我们新建一个数据库时，MySQL 会帮我们做两件事：

1. 在数据目录下创建一个和数据库名同名的子目录（或者说是文件夹）。
2. 在该子目录下创建一个名为 db.opt 的文件，这个文件中包含了该数据库的各种属性，比方说该数据库的字符集和比较规则是什么。

**注意： MySQL 拥有自带的系统数据库。但不是所有的系统数据库在 MySQL 的数据目录中都有对应的数据库目录。例如：information_schema 系统数据库，它的实现有些特殊，没有在 MySQL 的数据目录中对应的数据库目录。**

<br />

##### 表在文件系统中的表示

---

每个表的信息分为两种：

1. 表结构的定义。
2. 表中的数据。

InnoDB 和 MyISAM 这两种存储引擎都在数据目录下对应的数据库子目录下创建了一个专门用于描述表结构的文件，文件名是：`表名.frm`。以 .frm 为后缀名的文件是以二进制格式存储的。

对于表数据，InnoDB 和 MyISAM 这两个存储引擎用什么文件来保存表中数据就产生了分歧。

<br />

###### InnoDB 是如何存储表数据的

---

**表空间（又称文件空间）**，英文名为：Table Space (or File Space)。它对应文件系统上一个或多个真实文件（不同表空间对应的文件数量可能不同）。每一个表空间可以被划分为很多个页，我们的表数据就存放在某个表空间下的某些页里。表空间又划分为几种不同的类型：

1. 系统表空间（System Tablespace）：系统表空间可以对应文件系统上一个或多个实际的文件，默认在数据目录下会创建一个名为 ibdata1 ，大小为 12M 的自扩展文件（即在文件大小不够用的时候自己增加文件大小）。

   可以通过修改配置文件来修改上述的默认行为，如：

   ```mysql
   [server]
   -- 表示在 MySQL 启动后会创建两个 512M 大小的文件作为系统表空间（注意 data2 文件被 autoextend 标识，即 data2 文件自扩展）
   innodb_data_file_path=data1:512M;data2:512M:autoextend
   ```

   系统表空间的文件不一定要数据目录下，也可以自定义其路径，涉及到的启动参数为`innodb_data_file_path`和`innodb_data_home_dir`（具体使用参考官方文档）。

   **注意：在一个 MySQL 服务器中，系统表空间只有一份。从 MySQL5.5.7 到 MySQL5.6.6 之间的各个版本中，我们表中的数据都会被默认存储到这个系统表空间。在 MySQL5.6.6 以及之后的版本中，InnoDB 并不会默认的把各个表的数据存储到系统表空间中，而是为每一个表建立一个独立表空间。**

2. 独立表空间（File-per-table Tablespace）：使用独立表空间来存储表数据的话，会在该表所属数据库对应的子目录下创建一个表示该独立表空间的文件，文件名和表名相同，后缀名为`.ibd`，即`表名.ibd`。

   举个例子，我们使用了独立表空间去存储 xiaohaizi 数据库下的 test 表，会在数据库对应的目录下创建两个文件，分别为`test.frm`（存放表结构）和`test.ibd`（存放表数据和索引）。

   我们也可以自己指定使用系统表空间还是独立表空间来存储数据，在配置文件中书写如下：

   ```mysql
   [server]
   -- 参数值为 0 表示使用系统表空间，1 表示使用独立表空间
   -- 注意此参数只对新建的表起作用，对于已经分配了表空间的表并不起作用
   innodb_file_per_table=0
   ```

   把已经存在系统表空间中的表转移到独立表空间或反之，可以使用如下 sql 语句。

   ```mysql
   -- 系统表空间转独立表空间（“=” 可有可无）
   ALTER TABLE 表名 TABLESPACE [=] innodb_file_per_table;
   
   -- 独立表空间转系统表空间（“=” 可有可无）
   ALTER TABLE 表名 TABLESPACE [=] innodb_system;
   ```

3. 其他类型的表空间：

   * 通用表空间（General Tablespace）
   * undo表空间（Undo Tablespace）
   * 临时表空间（Temporary Tablespace）

<br />

###### MyISAM 是如何存储表数据的

---

MyISAM 将索引和数据分开存储，即**在 MyISAM 中索引是索引、数据是数据**。

MyISAM 将表中的记录按照记录的插入顺序单独存储在一个文件中，称之为**数据文件**。这个文件并不划分为若干个数据页，有多少记录就塞多少记录，我们可以通过行号快速的访问到一条记录。由于在插入数据的时候并没有刻意按照主键大小排序，所以我们并不能在这些数据上使用二分法进行查找。

对于索引，MyISAM 会将索引信息另外存储到一个称为**索引文件**的文件中。MyISAM 会单独为表的主键创建一个索引（也是树形结构），只不过在索引的叶子节点中存储的不是完整的用户记录，而是 主键值 + 行号 的组合。这也就是说，MyISAM 中建立的索引相当于全部都是二级索引（需要利用索引找到行号，然后用行号回表）！当然，如果有需要，我们也可以对其它的列分别建立索引或者建立联合索引，原理参照 InnoDB 中的索引，在叶子节点处存储的是 相应的列 + 行号 。

不要认为 MyISAM 索引回表很慢，因为它是拿着地址偏移量直接到文件中取数据的。

MyISAM 并没有什么所谓的表空间，他的表数据都存放到对应的数据库子目录下，以 test表为例，MyISAM 会在它所在数据库对应的目录下，为 test 表创建三个文件：

```mysql
-- 表结构文件
test.frm

-- 表数据文件（存放插入的用户记录）
test.MYD

-- 表索引文件（为该表创建的索引都会放到这个文件中）
test.MYI
```

由此可见，MyISAM 在文件系统中使用不同的文件来存储数据文件和索引文件。

<br />

##### 视图在文件系统中的表示

---

由于 Mysql 中的视图是一个虚拟的表，是某个查询语句的一个别名。所以存储视图的时候，不需要存储其真实的数据，只需要把它的结构存储起来就行了。和表类似，描述视图结构的文件会被存储到所属数据库对应的子目录下面，名为`视图名.frm`。

<br />

##### 其他的文件

---

除了用户自己存储的数据以外，数据目录还包括为了更好运行程序的一些额外文件。例如：

1. 服务器进程文件：我们知道每运行一个 MySQL 服务器程序，都意味着启动一个进程。 MySQL 服务器会把自己的 进程ID 写入到一个文件中。
2. 服务器日志文件：比如常规的查询日志、错误日志、二进制日志、redo日志等等各种日志。
3. 默认/自动生成的SSL和RSA证书和密钥文件：主要是为了客户端和服务器安全通信而创建的一些文件。

<br />

### 文件系统对数据库的影响

---

因为 MySQL 的数据都是存在文件系统中的，就不得不受到文件系统的一些制约：

1. 数据库名称和表名称不得超过文件系统所允许的最大长度。
2. 为了避免因为数据库名和表名出现某些特殊字符而造成文件系统不支持的情况，MySQL 会把数据库名和表名中所有除数字和拉丁字母以外的所有字符在文件名里都映射成 @+编码值 的形式作为文件名。例如： `test?.frm => test@003f.frm`。
3. 文件长度受文件系统最大长度限制。

<br />

### MySQL 系统数据库简介

---

还记得数据库在文件系统中的表示吗？在数据目录下，除了有用户自定义的数据库对应的目录，还有系统数据库对应的目录。以下是对他们的部分介绍。

<br />

#### mysql

---

核心的数据库，它存储了 MySQL 的用户账户和权限信息，一些存储过程、事件的定义信息，一些运行过程中产生的日志信息，一些帮助信息以及时区信息等。

<br />

#### information_schema

---

这个数据库保存着MySQL服务器维护的所有其他数据库的信息（如有哪些表、哪些视图）。这些信息并不是真实的用户数据，而是一些描述性信息，有时候也称之为元数据。

<br />

#### performance_schema

---

这个数据库里主要保存MySQL服务器运行过程中的一些状态信息(如最近执行了哪些语句)，算是对MySQL服务器的一个性能监控。

<br />

#### sys

---

这个数据库主要是通过视图的形式把 information_schema 和 performance_schema 结合起来，让程序员可以更方便的了解 MySQL 服务器的一些性能信息。
